<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Review Assistant - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-white p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <div class="flex items-center justify-center gap-3 mb-4">
                <i data-lucide="code" class="w-10 h-10 text-purple-400"></i>
                <h1 class="text-4xl font-bold">Code Review Assistant</h1>
                <button onclick="toggleSettings()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                    <i data-lucide="settings" class="w-6 h-6 text-purple-300"></i>
                </button>
            </div>
            <p class="text-purple-200">AI-powered code review powered by <a href="https://openrouter.ai" target="_blank" class="text-purple-300 hover:text-purple-200 underline">OpenRouter.ai</a></p>
            
            <div class="mt-4 flex items-center justify-center gap-4">
                <div class="px-4 py-2 rounded-lg glass">
                    <span class="text-green-400 flex items-center gap-2 text-sm">
                        <i data-lucide="key" class="w-4 h-4"></i> OpenRouter GPT-OSS-120B
                    </span>
                </div>
            </div>
        </div>

        <div id="settingsPanel" class="hidden mb-6 glass rounded-xl p-6">
            <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="key" class="w-5 h-5"></i> OpenRouter API Settings
            </h3>
            <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." 
                class="w-full px-4 py-2 rounded-lg bg-slate-800/50 text-white border border-white/20 focus:ring-2 focus:ring-purple-400 outline-none mb-4">
            <div class="mb-4 p-3 rounded-lg bg-blue-500/10 border border-blue-500/30">
                <p class="text-sm text-blue-200">
                    <i data-lucide="info" class="w-4 h-4 inline"></i> 
                    <strong>Note:</strong> Free models require enabling "Free model publication" in your 
                    <a href="https://openrouter.ai/settings/privacy" target="_blank" class="text-blue-400 hover:text-blue-300 underline">OpenRouter privacy settings</a>.
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="saveApiKey()" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 transition font-medium">Save Key</button>
                <button onclick="clearApiKey()" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 transition font-medium">Clear Key</button>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="glass rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">Your Code</h2>
                <div class="flex gap-2 flex-wrap mb-4" id="exampleButtons">
                    </div>
                <textarea id="codeInput" placeholder="Paste your code here..." 
                    class="w-full h-80 p-4 rounded-lg bg-slate-800/50 text-white font-mono text-sm border border-white/20 focus:ring-2 focus:ring-purple-400 outline-none resize-none"></textarea>
                
                <button id="analyzeBtn" onclick="analyzeCode()" class="w-full mt-4 px-6 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 font-semibold transition flex items-center justify-center gap-2">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    <span>Review Code with AI</span>
                </button>
            </div>

            <div class="glass rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">Review Results</h2>
                <div id="resultsContent" class="h-96 overflow-y-auto pr-2 flex flex-col items-center justify-center text-purple-200">
                    <i data-lucide="code" class="w-16 h-16 mb-4 opacity-30"></i>
                    <p>Paste your code and click "Review Code"</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let openRouterKey = localStorage.getItem('openrouter_key') || '';

        const examples = {
            javascript: `function calculateTotal(items) {\n  var total = 0;\n  for (var i = 0; i < items.length; i++) {\n    total = total + items[i].price * items[i].quantity;\n  }\n  return total;\n}`,
            python: `def find_user(users, user_id):\n    for user in users:\n        if user['id'] == user_id:\n            return user\n    return None`,
            react: `import React from 'react';\n\nfunction UserProfile({ user }) {\n  return (\n    <div style={{padding: '20px'}}>\n      <h1>{user.name}</h1>\n      <button onClick={() => alert('Hello')}>Greet</button>\n    </div>\n  );\n}`
        };

        // --- Logic ---

        function init() {
            lucide.createIcons();
            document.getElementById('apiKeyInput').value = openRouterKey;
            
            // Generate example buttons
            const btnContainer = document.getElementById('exampleButtons');
            Object.keys(examples).forEach(lang => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-1 text-xs rounded-lg bg-white/20 hover:bg-white/30 transition capitalize";
                btn.innerText = lang;
                btn.onclick = () => {
                    document.getElementById('codeInput').value = examples[lang];
                };
                btnContainer.appendChild(btn);
            });
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function saveApiKey() {
            const val = document.getElementById('apiKeyInput').value.trim();
            if (val) {
                localStorage.setItem('openrouter_key', val);
                openRouterKey = val;
                alert('Key saved!');
                toggleSettings();
            }
        }

        function clearApiKey() {
            localStorage.removeItem('openrouter_key');
            openRouterKey = '';
            document.getElementById('apiKeyInput').value = '';
            alert('Key cleared');
        }


        async function analyzeCode() {
            const code = document.getElementById('codeInput').value.trim();
            const resultsDiv = document.getElementById('resultsContent');
            const btn = document.getElementById('analyzeBtn');

            if (!code) return alert('Enter code first');
            if (!openRouterKey) {
                toggleSettings();
                return alert('Add OpenRouter API Key');
            }

            // UI Loading state
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin mr-2">‚è≥</span> Analyzing...`;
            resultsDiv.innerHTML = `<div class="flex flex-col items-center pt-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div><p>AI is analyzing your code...</p></div>`;

            try {
                // Create the prompt for code review
                const reviewPrompt = `Please review the following code and provide a detailed analysis in JSON format with the following structure:
{
  "improvements": [
    {
      "title": "Issue title",
      "description": "Detailed description of the issue and how to fix it"
    }
  ],
  "positive": {
    "title": "What's good about this code",
    "description": "Detailed description of positive aspects"
  }
}

Code to review:
\`\`\`
${code}
\`\`\`

IMPORTANT: Return ONLY valid JSON. Do not wrap it in markdown code blocks. Use double quotes for all strings. Escape any quotes inside string values with backslashes. Ensure all backticks inside descriptions are included as regular characters (not as code delimiters).`;

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${openRouterKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "openai/gpt-oss-120b:free",
                        "messages": [
                            {
                                "role": "user",
                                "content": reviewPrompt
                            }
                        ]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    let errorMsg = data.error.message || 'API request failed';
                    
                    // Provide helpful message for privacy policy error
                    if (data.error.code === 404 && errorMsg.includes('data policy')) {
                        errorMsg = `Privacy settings required! Please enable "Free model publication" in your OpenRouter settings: https://openrouter.ai/settings/privacy`;
                    }
                    
                    throw new Error(errorMsg);
                }

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from API');
                }

                let content = data.choices[0].message.content;
                let parsed;
                
                // Handle case where content is already an object (shouldn't happen but be safe)
                if (typeof content === 'object' && content !== null) {
                    parsed = content;
                } else {
                    // Remove markdown code blocks if present
                    content = content.replace(/```json|```/g, '').trim();
                    
                    // Try to parse - content might be a JSON string (double-encoded)
                    try {
                        // First attempt: parse directly
                        parsed = JSON.parse(content);
                        
                        // If first parse gives us a string, it's double-encoded - parse again
                        if (typeof parsed === 'string') {
                            // Clean up the inner JSON string before parsing
                            let innerContent = parsed.trim();
                            innerContent = innerContent.replace(/```json|```/g, '').trim();
                            parsed = JSON.parse(innerContent);
                        }
                    } catch (e) {
                        // If direct parsing fails, try to extract and fix JSON
                        // Look for JSON object pattern (handles cases with extra text)
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            try {
                                let jsonContent = jsonMatch[0];
                                // Try to fix common JSON issues: unescaped backticks in strings
                                // This is a simple fix - replace backticks inside string values with escaped versions
                                // Note: This is a heuristic and may not work for all cases
                                jsonContent = jsonContent.replace(/"([^"]*)`([^"]*)"/g, '"$1\\`$2"');
                                parsed = JSON.parse(jsonContent);
                            } catch (e2) {
                                // Last resort: try to extract just the JSON structure
                                // Log error with content preview for debugging
                                const preview = content.substring(0, 1000);
                                const errorDetails = e2.message + '\n\nTrying to parse:\n' + preview.substring(0, 200) + '...';
                                throw new Error('Could not parse JSON response. The AI may have returned invalid JSON.\n\n' + errorDetails);
                            }
                        } else {
                            throw new Error('Could not find JSON in response. The AI may not have returned valid JSON. Error: ' + e.message);
                        }
                    }
                }

                // Validate the parsed structure
                if (!parsed || typeof parsed !== 'object') {
                    throw new Error('Invalid response: expected JSON object');
                }
                if (!parsed.improvements || !Array.isArray(parsed.improvements)) {
                    throw new Error('Invalid response structure: missing improvements array');
                }
                if (!parsed.positive || !parsed.positive.title || !parsed.positive.description) {
                    throw new Error('Invalid response structure: missing positive feedback');
                }

                renderResults(parsed);

            } catch (err) {
                let errorHtml = `<div class="text-red-400 p-4 border border-red-500/50 rounded-lg bg-red-500/10">
                    <strong>Error:</strong> ${err.message}`;
                
                if (err.message.includes('Privacy settings') || err.message.includes('data policy')) {
                    errorHtml += `<br><br><a href="https://openrouter.ai/settings/privacy" target="_blank" class="text-blue-400 hover:text-blue-300 underline mt-2 inline-block">
                        <i data-lucide="external-link" class="w-4 h-4 inline"></i> Open Privacy Settings
                    </a>`;
                } else if (err.message.includes('JSON')) {
                    errorHtml += `<br><small class="text-red-300 mt-2 block">The AI response could not be parsed. Please try again.</small>`;
                }
                
                errorHtml += `</div>`;
                resultsDiv.innerHTML = errorHtml;
                lucide.createIcons();
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5"></i><span>Review Code with AI</span>`;
                lucide.createIcons();
            }
        }

        function renderResults(data) {
            const resultsDiv = document.getElementById('resultsContent');
            resultsDiv.className = "space-y-4 text-left block h-full";
            
            let improvementsHtml = data.improvements.map((imp, idx) => `
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-300 mb-1">${idx + 1}. ${imp.title}</h4>
                    <p class="text-sm text-yellow-100">${imp.description}</p>
                </div>
            `).join('');

            resultsDiv.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-yellow-400 font-bold mb-3 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5"></i> Improvements</h3>
                    ${improvementsHtml}
                </div>
                <div>
                    <h3 class="text-green-400 font-bold mb-3 flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> What's Good</h3>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                        <h4 class="font-semibold text-green-300 mb-1">${data.positive.title}</h4>
                        <p class="text-sm text-green-100">${data.positive.description}</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.onload = init;
    </script>
</body>
</html>
